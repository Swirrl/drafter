#!/usr/bin/env bash

set -e

# NOTE: This script should be executed from within the drafter repository
REPO_DIR=$(git rev-parse --show-toplevel)
DRAFTER_DIR="${REPO_DIR}/drafter"
TARGET_DIR="${DRAFTER_DIR}/target"
LIB_DIR="${TARGET_DIR}/lib"
DRAFTER_JAR="${TARGET_DIR}/drafter.jar"

# clean existing
if [ -d "${TARGET_DIR}" ]; then
  if [ -d "${LIB_DIR}" ]; then
    rm -r "${LIB_DIR}"
  fi


  if [ -f "${DRAFTER_JAR}" ]; then
    rm "${DRAFTER_JAR}"
  fi
else
  mkdir "${TARGET_DIR}"
fi

# pack
pushd "${DRAFTER_DIR}" || exit
trap "popd" EXIT

clojure -M:prod:pack -e env/prod/clj --lib-dir "${LIB_DIR}" --project-path "${DRAFTER_JAR}"
