language: java
sudo: required
dist: trusty
lein: 2.9.1
jdk:
  - openjdk8
services:
  - docker
env:
  global:
    - SPARQL_QUERY_ENDPOINT='http://localhost:5820/drafter-client-test/query'
    - SPARQL_UPDATE_ENDPOINT='http://localhost:5820/drafter-client-test/update'
    - DRAFTER_ENDPOINT='http://localhost:3001'
    - DRAFTER_JWS_SIGNING_KEY=foo
    - AUTH0_DOMAIN=https://dev-kkt-m758.eu.auth0.com
    - AUTH0_AUD=https://pmd
    - AUTH0_CLIENT_ID=7klE25HUY333vTEx7rM1dmsnO6vHkaSG
    - AUTH0_CLIENT_SECRET=QYoWNwf11dzWNh6XYd3jH8-j5j8r36UKuoFgrPakE_aw_Gy_EwWSppvqSULRICY4
cache:
  directories:
    - $HOME/.m2
    - .cpcache # tools.deps classpath cache
    - drafter/.cpcache # tools.deps classpath cache
before_install:
  - "sudo ./travis/install_base.sh"
  - "./travis/install_services.sh"
install:
  - cd drafter && clojure -A:dev:test -Spath && cd ..
  - cd drafter-client && clojure -A:dev:test -Spath && cd ..
before_script:
  - "./travis/before_script.sh"
script:
  - ./travis/test-all
after_success:
  - ./travis/after_success.sh
before_deploy:
  - export TRAVIS_BRANCH=$(echo $TRAVIS_BRANCH | sed -e 's=/=_=g')
  - echo $TRAVIS_BRANCH
  - "./travis/before_deploy.sh"
deploy:
  - provider: s3
    access_key_id: AKIAJZVFELTIBDDYV5OQ
    secret_access_key:
      secure: BIaToFo+lK7GB+/IQhEAR44Ix18+ykJt+HIR6uxzZi3WRDuAP+JjngPf+A9rwKQ3fooyAgNZLnIp4EP00rpJ+YfAdUeQzxpcJxeMeUgH0hAR7o8udMTujqBLsTjxwI7B8nZGUHpUpVZiAG4SWhgm7QaU/x5/tTSmGk9inO6SJQY=
    bucket: travis-drafter-jars
    local-dir: drafter/dist
    upload-dir: travis-$TRAVIS_BRANCH
    region: eu-west-1
    skip_cleanup: true
    on:
      repo: Swirrl/drafter
      all_branches: true
  - provider: releases
    api_key: "$RELEASE_OAUTH_TOKEN"
    file: "drafter/releases/drafter-$TRAVIS_TAG-$TRAVIS_BUILD_NUMBER.jar"
    skip_cleanup: true
    on:
      tags: true
      condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+$
  - provider: releases
    api_key: "$RELEASE_OAUTH_TOKEN"
    file: "drafter/releases/drafter-$TRAVIS_TAG-$TRAVIS_BUILD_NUMBER.jar"
    prerelease: true
    skip_cleanup: true
    on:
      tags: true
      condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+-.+$
  - provider: script
    script: drafter/bin/deploy
    skip_cleanup: true
    on:
      tags: true
  - provider: script
    script: clojure -M:omni publish -m package/manifest.edn
    skip_cleanup: true
    on:
      all_branches: true
