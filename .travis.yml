language: clojure
sudo: required
lein: 2.9.1
jdk:
- oraclejdk8
services:
  - mongodb
env:
  global:
  - STARDOG_VERSION='stardog-5.2.0'
cache:
  directories:
  - $HOME/.m2
before_install:
- sudo travis/install_base.sh
- curl 'https://raw.githubusercontent.com/Swirrl/stardog/master/consume/setup-stardog?token=AABCpLUdCWZQ-1MW8nm70bQLGqZJfGNeks5csMkIwA%3D%3D' | env STARDOG_BUILD=stardog-5.2.0-21 CREATE_DB=drafter-test-db START_STARDOG=true AWS_INSTALL=true bash
install:
- cd drafter
- lein deps
- cd ../drafter-client
- lein deps
- cd ..
script:
  - "./travis/test-all"
after_success:
- cd ../drafter
- env LEIN_SNAPSHOTS_IN_RELEASE=true lein uberjar
before_deploy:
- "./travis/before_deploy.sh"
deploy:
  - provider: s3
    access_key_id: AKIAJZVFELTIBDDYV5OQ
    secret_access_key:
      secure: BIaToFo+lK7GB+/IQhEAR44Ix18+ykJt+HIR6uxzZi3WRDuAP+JjngPf+A9rwKQ3fooyAgNZLnIp4EP00rpJ+YfAdUeQzxpcJxeMeUgH0hAR7o8udMTujqBLsTjxwI7B8nZGUHpUpVZiAG4SWhgm7QaU/x5/tTSmGk9inO6SJQY=
    bucket: travis-drafter-jars
    local-dir: drafter/dist
    upload-dir: travis-$TRAVIS_BRANCH
    region: eu-west-1
    skip_cleanup: true
    on:
      repo: Swirrl/drafter
      all_branches: true
  - provider: releases
    api_key: "$RELEASE_OAUTH_TOKEN"
    file: "drafter/releases/drafter-$TRAVIS_TAG-$TRAVIS_BUILD_NUMBER.jar"
    skip_cleanup: true
    on:
      tags: true
      condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+$
  - provider: releases
    api_key: "$RELEASE_OAUTH_TOKEN"
    file: "drafter/releases/drafter-$TRAVIS_TAG-$TRAVIS_BUILD_NUMBER.jar"
    prerelease: true
    skip_cleanup: true
    on:
      tags: true
      condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+-.+$
  - provider: script
    script: lein deploy
    skip_cleanup: true
    on:
      tags: true
